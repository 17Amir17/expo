{"version":3,"file":"baseJSBundle.js","names":["_jscSafeUrl","data","require","_getAppendScripts","_interopRequireDefault","_processModules","obj","__esModule","default","getPlatformOption","graph","options","_graph$transformOptio","_url$searchParams$get","transformOptions","platform","sourceUrl","isJscSafeUrl","toNormalUrl","url","URL","searchParams","get","getSplitChunksOption","includeAsyncPaths","getBaseUrlOption","_url$searchParams$get2","serializerOptions","baseUrl","baseJSBundle","entryPoint","preModules","_getBaseUrlOption","Error","baseJSBundleWithDependencies","dependencies","values","splitChunks","module","createModuleId","path","processModulesOptions","filter","processModuleFilter","dev","projectRoot","serverRoot","modulesOnly","preCode","processModules","map","code","src","join","modules","sort","a","b","postCode","getAppendScripts","asyncRequireModulePath","getRunModuleStatement","inlineSourceMap","runBeforeMainModule","runModule","shouldAddToIgnoreList","sourceMapUrl","mods","pre","post","id","_expoSplitBundlePaths","paths"],"sources":["../../../src/serializer/fork/baseJSBundle.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * Fork with bundle splitting and better source map support.\n * https://github.com/facebook/metro/blob/bbdd7d7c5e6e0feb50a9967ffae1f723c1d7c4e8/packages/metro/src/DeltaBundler/Serializers/baseJSBundle.js#L1\n */\n\nimport { isJscSafeUrl, toNormalUrl } from 'jsc-safe-url';\nimport type { MixedOutput, Module, ReadOnlyGraph, SerializerOptions } from 'metro';\nimport getAppendScripts from 'metro/src/lib/getAppendScripts';\n\nimport { processModules } from './processModules';\n\nexport type ModuleMap = [number, string][];\n\nexport type Bundle = {\n  modules: ModuleMap;\n  post: string;\n  pre: string;\n  _expoSplitBundlePaths: [number, Record<string, string>][];\n};\n\nexport function getPlatformOption(\n  graph: Pick<ReadOnlyGraph, 'transformOptions'>,\n  options: SerializerOptions\n): string | null {\n  if (graph.transformOptions?.platform != null) {\n    return graph.transformOptions.platform;\n  }\n  if (!options.sourceUrl) {\n    return null;\n  }\n\n  const sourceUrl = isJscSafeUrl(options.sourceUrl)\n    ? toNormalUrl(options.sourceUrl)\n    : options.sourceUrl;\n  const url = new URL(sourceUrl, 'https://expo.dev');\n  return url.searchParams.get('platform') ?? null;\n}\n\nexport function getSplitChunksOption(\n  graph: Pick<ReadOnlyGraph, 'transformOptions'>,\n  options: SerializerOptions\n): boolean {\n  // Only enable when the entire bundle is being split, and only run on web.\n  return !options.includeAsyncPaths && getPlatformOption(graph, options) === 'web';\n}\n\nexport function getBaseUrlOption(\n  graph: Pick<ReadOnlyGraph, 'transformOptions'>,\n  options: SerializerOptions\n): string | null {\n  // @ts-expect-error\n  if (options.serializerOptions != null) {\n    // @ts-expect-error\n    return options.serializerOptions.baseUrl;\n  }\n\n  if (!options.sourceUrl) {\n    return null;\n  }\n\n  const sourceUrl = isJscSafeUrl(options.sourceUrl)\n    ? toNormalUrl(options.sourceUrl)\n    : options.sourceUrl;\n  const url = new URL(sourceUrl, 'https://expo.dev');\n  return url.searchParams.get('serializer.baseUrl') ?? null;\n}\n\nexport function baseJSBundle(\n  entryPoint: string,\n  preModules: readonly Module[],\n  graph: Pick<ReadOnlyGraph, 'dependencies' | 'transformOptions'>,\n  options: SerializerOptions\n): Bundle {\n  const platform = getPlatformOption(graph, options);\n  if (platform == null) {\n    throw new Error('platform could not be determined for Metro bundle');\n  }\n\n  return baseJSBundleWithDependencies(entryPoint, preModules, [...graph.dependencies.values()], {\n    ...options,\n    baseUrl: getBaseUrlOption(graph, options) ?? '/',\n    splitChunks: getSplitChunksOption(graph, options),\n    platform,\n  });\n}\n\nexport function baseJSBundleWithDependencies(\n  entryPoint: string,\n  preModules: readonly Module[],\n  dependencies: Module<MixedOutput>[],\n  options: SerializerOptions & { platform: string; baseUrl: string; splitChunks: boolean }\n): Bundle {\n  for (const module of dependencies) {\n    options.createModuleId(module.path);\n  }\n\n  const processModulesOptions = {\n    filter: options.processModuleFilter,\n    createModuleId: options.createModuleId,\n    dev: options.dev,\n    includeAsyncPaths: options.includeAsyncPaths,\n    projectRoot: options.projectRoot,\n    serverRoot: options.serverRoot,\n    sourceUrl: options.sourceUrl,\n    platform: options.platform,\n    baseUrl: options.baseUrl,\n    splitChunks: options.splitChunks,\n  };\n\n  // Do not prepend polyfills or the require runtime when only modules are requested\n  if (options.modulesOnly) {\n    preModules = [];\n  }\n\n  const preCode = processModules(preModules, processModulesOptions)\n    .map(([, code]) => code.src)\n    .join('\\n');\n\n  const modules = [...dependencies].sort(\n    (a: Module<MixedOutput>, b: Module<MixedOutput>) =>\n      options.createModuleId(a.path) - options.createModuleId(b.path)\n  );\n\n  const postCode = processModules(\n    getAppendScripts(entryPoint, [...preModules, ...modules], {\n      asyncRequireModulePath: options.asyncRequireModulePath,\n      createModuleId: options.createModuleId,\n      getRunModuleStatement: options.getRunModuleStatement,\n      inlineSourceMap: options.inlineSourceMap,\n      runBeforeMainModule: options.runBeforeMainModule,\n      runModule: options.runModule,\n      shouldAddToIgnoreList: options.shouldAddToIgnoreList,\n      sourceMapUrl: options.sourceMapUrl,\n      sourceUrl: options.sourceUrl,\n    }),\n    processModulesOptions\n  )\n    .map(([, code]) => code.src)\n    .join('\\n');\n\n  const mods = processModules([...dependencies], processModulesOptions).map(([module, code]) => [\n    options.createModuleId(module.path),\n    code,\n  ]);\n  return {\n    pre: preCode,\n    post: postCode,\n    modules: mods.map(([id, code]) => [\n      id,\n      typeof code === 'number' ? code : code.src,\n    ]) as ModuleMap,\n    _expoSplitBundlePaths: mods.map(([id, code]) => [\n      id,\n      typeof code === 'number' ? {} : code.paths,\n    ]) as [number, Record<string, string>][],\n  };\n}\n"],"mappings":";;;;;;;;;;AAWA,SAAAA,YAAA;EAAA,MAAAC,IAAA,GAAAC,OAAA;EAAAF,WAAA,YAAAA,CAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAEA,SAAAE,kBAAA;EAAA,MAAAF,IAAA,GAAAG,sBAAA,CAAAF,OAAA;EAAAC,iBAAA,YAAAA,CAAA;IAAA,OAAAF,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAEA,SAAAI,gBAAA;EAAA,MAAAJ,IAAA,GAAAC,OAAA;EAAAG,eAAA,YAAAA,CAAA;IAAA,OAAAJ,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAAkD,SAAAG,uBAAAE,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAflD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAiBO,SAASG,iBAAiBA,CAC/BC,KAA8C,EAC9CC,OAA0B,EACX;EAAA,IAAAC,qBAAA,EAAAC,qBAAA;EACf,IAAI,EAAAD,qBAAA,GAAAF,KAAK,CAACI,gBAAgB,cAAAF,qBAAA,uBAAtBA,qBAAA,CAAwBG,QAAQ,KAAI,IAAI,EAAE;IAC5C,OAAOL,KAAK,CAACI,gBAAgB,CAACC,QAAQ;EACxC;EACA,IAAI,CAACJ,OAAO,CAACK,SAAS,EAAE;IACtB,OAAO,IAAI;EACb;EAEA,MAAMA,SAAS,GAAG,IAAAC,0BAAY,EAACN,OAAO,CAACK,SAAS,CAAC,GAC7C,IAAAE,yBAAW,EAACP,OAAO,CAACK,SAAS,CAAC,GAC9BL,OAAO,CAACK,SAAS;EACrB,MAAMG,GAAG,GAAG,IAAIC,GAAG,CAACJ,SAAS,EAAE,kBAAkB,CAAC;EAClD,QAAAH,qBAAA,GAAOM,GAAG,CAACE,YAAY,CAACC,GAAG,CAAC,UAAU,CAAC,cAAAT,qBAAA,cAAAA,qBAAA,GAAI,IAAI;AACjD;AAEO,SAASU,oBAAoBA,CAClCb,KAA8C,EAC9CC,OAA0B,EACjB;EACT;EACA,OAAO,CAACA,OAAO,CAACa,iBAAiB,IAAIf,iBAAiB,CAACC,KAAK,EAAEC,OAAO,CAAC,KAAK,KAAK;AAClF;AAEO,SAASc,gBAAgBA,CAC9Bf,KAA8C,EAC9CC,OAA0B,EACX;EAAA,IAAAe,sBAAA;EACf;EACA,IAAIf,OAAO,CAACgB,iBAAiB,IAAI,IAAI,EAAE;IACrC;IACA,OAAOhB,OAAO,CAACgB,iBAAiB,CAACC,OAAO;EAC1C;EAEA,IAAI,CAACjB,OAAO,CAACK,SAAS,EAAE;IACtB,OAAO,IAAI;EACb;EAEA,MAAMA,SAAS,GAAG,IAAAC,0BAAY,EAACN,OAAO,CAACK,SAAS,CAAC,GAC7C,IAAAE,yBAAW,EAACP,OAAO,CAACK,SAAS,CAAC,GAC9BL,OAAO,CAACK,SAAS;EACrB,MAAMG,GAAG,GAAG,IAAIC,GAAG,CAACJ,SAAS,EAAE,kBAAkB,CAAC;EAClD,QAAAU,sBAAA,GAAOP,GAAG,CAACE,YAAY,CAACC,GAAG,CAAC,oBAAoB,CAAC,cAAAI,sBAAA,cAAAA,sBAAA,GAAI,IAAI;AAC3D;AAEO,SAASG,YAAYA,CAC1BC,UAAkB,EAClBC,UAA6B,EAC7BrB,KAA+D,EAC/DC,OAA0B,EAClB;EAAA,IAAAqB,iBAAA;EACR,MAAMjB,QAAQ,GAAGN,iBAAiB,CAACC,KAAK,EAAEC,OAAO,CAAC;EAClD,IAAII,QAAQ,IAAI,IAAI,EAAE;IACpB,MAAM,IAAIkB,KAAK,CAAC,mDAAmD,CAAC;EACtE;EAEA,OAAOC,4BAA4B,CAACJ,UAAU,EAAEC,UAAU,EAAE,CAAC,GAAGrB,KAAK,CAACyB,YAAY,CAACC,MAAM,EAAE,CAAC,EAAE;IAC5F,GAAGzB,OAAO;IACViB,OAAO,GAAAI,iBAAA,GAAEP,gBAAgB,CAACf,KAAK,EAAEC,OAAO,CAAC,cAAAqB,iBAAA,cAAAA,iBAAA,GAAI,GAAG;IAChDK,WAAW,EAAEd,oBAAoB,CAACb,KAAK,EAAEC,OAAO,CAAC;IACjDI;EACF,CAAC,CAAC;AACJ;AAEO,SAASmB,4BAA4BA,CAC1CJ,UAAkB,EAClBC,UAA6B,EAC7BI,YAAmC,EACnCxB,OAAwF,EAChF;EACR,KAAK,MAAM2B,MAAM,IAAIH,YAAY,EAAE;IACjCxB,OAAO,CAAC4B,cAAc,CAACD,MAAM,CAACE,IAAI,CAAC;EACrC;EAEA,MAAMC,qBAAqB,GAAG;IAC5BC,MAAM,EAAE/B,OAAO,CAACgC,mBAAmB;IACnCJ,cAAc,EAAE5B,OAAO,CAAC4B,cAAc;IACtCK,GAAG,EAAEjC,OAAO,CAACiC,GAAG;IAChBpB,iBAAiB,EAAEb,OAAO,CAACa,iBAAiB;IAC5CqB,WAAW,EAAElC,OAAO,CAACkC,WAAW;IAChCC,UAAU,EAAEnC,OAAO,CAACmC,UAAU;IAC9B9B,SAAS,EAAEL,OAAO,CAACK,SAAS;IAC5BD,QAAQ,EAAEJ,OAAO,CAACI,QAAQ;IAC1Ba,OAAO,EAAEjB,OAAO,CAACiB,OAAO;IACxBS,WAAW,EAAE1B,OAAO,CAAC0B;EACvB,CAAC;;EAED;EACA,IAAI1B,OAAO,CAACoC,WAAW,EAAE;IACvBhB,UAAU,GAAG,EAAE;EACjB;EAEA,MAAMiB,OAAO,GAAG,IAAAC,gCAAc,EAAClB,UAAU,EAAEU,qBAAqB,CAAC,CAC9DS,GAAG,CAAC,CAAC,GAAGC,IAAI,CAAC,KAAKA,IAAI,CAACC,GAAG,CAAC,CAC3BC,IAAI,CAAC,IAAI,CAAC;EAEb,MAAMC,OAAO,GAAG,CAAC,GAAGnB,YAAY,CAAC,CAACoB,IAAI,CACpC,CAACC,CAAsB,EAAEC,CAAsB,KAC7C9C,OAAO,CAAC4B,cAAc,CAACiB,CAAC,CAAChB,IAAI,CAAC,GAAG7B,OAAO,CAAC4B,cAAc,CAACkB,CAAC,CAACjB,IAAI,CAAC,CAClE;EAED,MAAMkB,QAAQ,GAAG,IAAAT,gCAAc,EAC7B,IAAAU,2BAAgB,EAAC7B,UAAU,EAAE,CAAC,GAAGC,UAAU,EAAE,GAAGuB,OAAO,CAAC,EAAE;IACxDM,sBAAsB,EAAEjD,OAAO,CAACiD,sBAAsB;IACtDrB,cAAc,EAAE5B,OAAO,CAAC4B,cAAc;IACtCsB,qBAAqB,EAAElD,OAAO,CAACkD,qBAAqB;IACpDC,eAAe,EAAEnD,OAAO,CAACmD,eAAe;IACxCC,mBAAmB,EAAEpD,OAAO,CAACoD,mBAAmB;IAChDC,SAAS,EAAErD,OAAO,CAACqD,SAAS;IAC5BC,qBAAqB,EAAEtD,OAAO,CAACsD,qBAAqB;IACpDC,YAAY,EAAEvD,OAAO,CAACuD,YAAY;IAClClD,SAAS,EAAEL,OAAO,CAACK;EACrB,CAAC,CAAC,EACFyB,qBAAqB,CACtB,CACES,GAAG,CAAC,CAAC,GAAGC,IAAI,CAAC,KAAKA,IAAI,CAACC,GAAG,CAAC,CAC3BC,IAAI,CAAC,IAAI,CAAC;EAEb,MAAMc,IAAI,GAAG,IAAAlB,gCAAc,EAAC,CAAC,GAAGd,YAAY,CAAC,EAAEM,qBAAqB,CAAC,CAACS,GAAG,CAAC,CAAC,CAACZ,MAAM,EAAEa,IAAI,CAAC,KAAK,CAC5FxC,OAAO,CAAC4B,cAAc,CAACD,MAAM,CAACE,IAAI,CAAC,EACnCW,IAAI,CACL,CAAC;EACF,OAAO;IACLiB,GAAG,EAAEpB,OAAO;IACZqB,IAAI,EAAEX,QAAQ;IACdJ,OAAO,EAAEa,IAAI,CAACjB,GAAG,CAAC,CAAC,CAACoB,EAAE,EAAEnB,IAAI,CAAC,KAAK,CAChCmB,EAAE,EACF,OAAOnB,IAAI,KAAK,QAAQ,GAAGA,IAAI,GAAGA,IAAI,CAACC,GAAG,CAC3C,CAAc;IACfmB,qBAAqB,EAAEJ,IAAI,CAACjB,GAAG,CAAC,CAAC,CAACoB,EAAE,EAAEnB,IAAI,CAAC,KAAK,CAC9CmB,EAAE,EACF,OAAOnB,IAAI,KAAK,QAAQ,GAAG,CAAC,CAAC,GAAGA,IAAI,CAACqB,KAAK,CAC3C;EACH,CAAC;AACH"}