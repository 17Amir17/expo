{"version":3,"file":"transform-worker.js","names":["_metroTransformWorker","data","_interopRequireDefault","require","_css","_cssModules","_postcss","_sass","_svgModules","obj","__esModule","default","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireWildcard","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","countLines","transform","config","projectRoot","filename","options","_options$customTransf","_options$customTransf2","_options$customTransf3","customTransformOptions","matchSvgModule","transformSvg","type","worker","test","transformCss","environment","match","RegExp","platform","minify","Buffer","from","_jsModuleResults$outp2","code","matchCssModule","toString","transformPostCssModule","src","syntax","matchSass","compileSass","_jsModuleResults$outp","results","transformCssModuleWeb","dev","sourceMap","jsModuleResults","output","cssCode","css","lineCount","map","functionMap","dependencies","Promise","resolve","then","cssResults","cssModules","wrapDevelopmentCSS","module","exports"],"sources":["../../src/transform-worker/transform-worker.ts"],"sourcesContent":["/**\n * Copyright 2023-present 650 Industries (Expo). All rights reserved.\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport { FBSourceFunctionMap, MetroSourceMapSegmentTuple } from 'metro-source-map';\nimport worker, {\n  JsTransformerConfig,\n  JsTransformOptions,\n  TransformResponse,\n} from 'metro-transform-worker';\n\nimport { wrapDevelopmentCSS } from './css';\nimport { matchCssModule, transformCssModuleWeb } from './css-modules';\nimport { transformPostCssModule } from './postcss';\nimport { compileSass, matchSass } from './sass';\nimport { matchSvgModule, transformSvg } from './svg-modules';\n\nconst countLines = require('metro/src/lib/countLines') as (string: string) => number;\n\ntype JSFileType = 'js/script' | 'js/module' | 'js/module/asset';\n\ntype JsOutput = {\n  data: {\n    code: string;\n    lineCount: number;\n    map: MetroSourceMapSegmentTuple[];\n    functionMap: FBSourceFunctionMap | null;\n  };\n  type: JSFileType;\n};\n\nexport async function transform(\n  config: JsTransformerConfig,\n  projectRoot: string,\n  filename: string,\n  data: Buffer,\n  options: JsTransformOptions\n): Promise<TransformResponse> {\n  // SVG Modules must be first\n  if (options.customTransformOptions?.['svg-modules']) {\n    if (matchSvgModule(filename)) {\n      return transformSvg(config, projectRoot, filename, data, {\n        ...options,\n        // SVG Modules are still processed as assets, but we need to transform them as modules.\n        type: 'module',\n      });\n    }\n  }\n\n  if (options.type === 'asset') {\n    return worker.transform(config, projectRoot, filename, data, options);\n  }\n\n  if (options.customTransformOptions?.['css-modules']) {\n    if (/\\.(s?css|sass)$/.test(filename)) {\n      return transformCss(config, projectRoot, filename, data, options);\n    }\n  }\n\n  const environment = options.customTransformOptions?.environment;\n\n  if (\n    environment === 'client' &&\n    // TODO: Ensure this works with windows.\n    // TODO: Add +api files.\n    filename.match(new RegExp(`^app/\\\\+html(\\\\.${options.platform})?\\\\.([tj]sx?|[cm]js)?$`))\n  ) {\n    // Remove the server-only +html file from the bundle when bundling for a client environment.\n    return worker.transform(\n      config,\n      projectRoot,\n      filename,\n      !options.minify\n        ? Buffer.from(\n            // Use a string so this notice is visible in the bundle if the user is\n            // looking for it.\n            '\"> The server-only +html file was removed from the client JS bundle by Expo CLI.\"'\n          )\n        : Buffer.from(''),\n      options\n    );\n  }\n\n  return worker.transform(config, projectRoot, filename, data, options);\n}\n\nexport async function transformCss(\n  config: JsTransformerConfig,\n  projectRoot: string,\n  filename: string,\n  data: Buffer,\n  options: JsTransformOptions\n): Promise<TransformResponse> {\n  // If the platform is not web, then return an empty module.\n  if (options.platform !== 'web') {\n    const code = matchCssModule(filename) ? 'module.exports={ unstable_styles: {} };' : '';\n    return worker.transform(\n      config,\n      projectRoot,\n      filename,\n      // TODO: Native CSS Modules\n      Buffer.from(code),\n      options\n    );\n  }\n\n  let code = data.toString('utf8');\n\n  // Apply postcss transforms\n  code = await transformPostCssModule(projectRoot, {\n    src: code,\n    filename,\n  });\n\n  // TODO: When native has CSS support, this will need to move higher up.\n  const syntax = matchSass(filename);\n  if (syntax) {\n    code = compileSass(projectRoot, { filename, src: code }, { syntax }).src;\n  }\n\n  // If the file is a CSS Module, then transform it to a JS module\n  // in development and a static CSS file in production.\n  if (matchCssModule(filename)) {\n    const results = await transformCssModuleWeb({\n      filename,\n      src: code,\n      options: {\n        projectRoot,\n        dev: options.dev,\n        minify: options.minify,\n        sourceMap: false,\n      },\n    });\n\n    const jsModuleResults = await worker.transform(\n      config,\n      projectRoot,\n      filename,\n      Buffer.from(results.output),\n      options\n    );\n\n    const cssCode = results.css.toString();\n    const output: JsOutput[] = [\n      {\n        type: 'js/module',\n        data: {\n          // @ts-expect-error\n          ...jsModuleResults.output[0]?.data,\n\n          // Append additional css metadata for static extraction.\n          css: {\n            code: cssCode,\n            lineCount: countLines(cssCode),\n            map: [],\n            functionMap: null,\n          },\n        },\n      },\n    ];\n\n    return {\n      dependencies: jsModuleResults.dependencies,\n      output,\n    };\n  }\n\n  // Global CSS:\n\n  const { transform } = await import('lightningcss');\n\n  // TODO: Add bundling to resolve imports\n  // https://lightningcss.dev/bundling.html#bundling-order\n\n  const cssResults = transform({\n    filename,\n    code: Buffer.from(code),\n    sourceMap: false,\n    cssModules: false,\n    projectRoot,\n    minify: options.minify,\n  });\n\n  // TODO: Warnings:\n  // cssResults.warnings.forEach((warning) => {\n  // });\n\n  // Create a mock JS module that exports an empty object,\n  // this ensures Metro dependency graph is correct.\n  const jsModuleResults = await worker.transform(\n    config,\n    projectRoot,\n    filename,\n    options.dev ? Buffer.from(wrapDevelopmentCSS({ src: code, filename })) : Buffer.from(''),\n    options\n  );\n\n  const cssCode = cssResults.code.toString();\n\n  // In production, we export the CSS as a string and use a special type to prevent\n  // it from being included in the JS bundle. We'll extract the CSS like an asset later\n  // and append it to the HTML bundle.\n  const output: JsOutput[] = [\n    {\n      type: 'js/module',\n      data: {\n        // @ts-expect-error\n        ...jsModuleResults.output[0]?.data,\n\n        // Append additional css metadata for static extraction.\n        css: {\n          code: cssCode,\n          lineCount: countLines(cssCode),\n          map: [],\n          functionMap: null,\n        },\n      },\n    },\n  ];\n\n  return {\n    dependencies: jsModuleResults.dependencies,\n    output,\n  };\n}\n\n/**\n * A custom Metro transformer that adds support for processing Expo-specific bundler features.\n * - Global CSS files on web.\n * - CSS Modules on web.\n * - TODO: Tailwind CSS on web.\n */\nmodule.exports = {\n  // Use defaults for everything that's not custom.\n  ...worker,\n  transform,\n};\n"],"mappings":";;;;;;;AAQA,SAAAA,sBAAA;EAAA,MAAAC,IAAA,GAAAC,sBAAA,CAAAC,OAAA;EAAAH,qBAAA,YAAAA,CAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAMA,SAAAG,KAAA;EAAA,MAAAH,IAAA,GAAAE,OAAA;EAAAC,IAAA,YAAAA,CAAA;IAAA,OAAAH,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAI,YAAA;EAAA,MAAAJ,IAAA,GAAAE,OAAA;EAAAE,WAAA,YAAAA,CAAA;IAAA,OAAAJ,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAK,SAAA;EAAA,MAAAL,IAAA,GAAAE,OAAA;EAAAG,QAAA,YAAAA,CAAA;IAAA,OAAAL,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAM,MAAA;EAAA,MAAAN,IAAA,GAAAE,OAAA;EAAAI,KAAA,YAAAA,CAAA;IAAA,OAAAN,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAO,YAAA;EAAA,MAAAP,IAAA,GAAAE,OAAA;EAAAK,WAAA,YAAAA,CAAA;IAAA,OAAAP,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAA6D,SAAAC,uBAAAO,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAAA,SAAAG,yBAAAC,WAAA,eAAAC,OAAA,kCAAAC,iBAAA,OAAAD,OAAA,QAAAE,gBAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,WAAA,WAAAA,WAAA,GAAAG,gBAAA,GAAAD,iBAAA,KAAAF,WAAA;AAAA,SAAAI,wBAAAR,GAAA,EAAAI,WAAA,SAAAA,WAAA,IAAAJ,GAAA,IAAAA,GAAA,CAAAC,UAAA,WAAAD,GAAA,QAAAA,GAAA,oBAAAA,GAAA,wBAAAA,GAAA,4BAAAE,OAAA,EAAAF,GAAA,UAAAS,KAAA,GAAAN,wBAAA,CAAAC,WAAA,OAAAK,KAAA,IAAAA,KAAA,CAAAC,GAAA,CAAAV,GAAA,YAAAS,KAAA,CAAAE,GAAA,CAAAX,GAAA,SAAAY,MAAA,WAAAC,qBAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,GAAA,IAAAjB,GAAA,QAAAiB,GAAA,kBAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAApB,GAAA,EAAAiB,GAAA,SAAAI,IAAA,GAAAR,qBAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAhB,GAAA,EAAAiB,GAAA,cAAAI,IAAA,KAAAA,IAAA,CAAAV,GAAA,IAAAU,IAAA,CAAAC,GAAA,KAAAR,MAAA,CAAAC,cAAA,CAAAH,MAAA,EAAAK,GAAA,EAAAI,IAAA,YAAAT,MAAA,CAAAK,GAAA,IAAAjB,GAAA,CAAAiB,GAAA,SAAAL,MAAA,CAAAV,OAAA,GAAAF,GAAA,MAAAS,KAAA,IAAAA,KAAA,CAAAa,GAAA,CAAAtB,GAAA,EAAAY,MAAA,YAAAA,MAAA;AAE7D,MAAMW,UAAU,GAAG7B,OAAO,CAAC,0BAA0B,CAA+B;AAc7E,eAAe8B,SAASA,CAC7BC,MAA2B,EAC3BC,WAAmB,EACnBC,QAAgB,EAChBnC,IAAY,EACZoC,OAA2B,EACC;EAAA,IAAAC,qBAAA,EAAAC,sBAAA,EAAAC,sBAAA;EAC5B;EACA,KAAAF,qBAAA,GAAID,OAAO,CAACI,sBAAsB,cAAAH,qBAAA,eAA9BA,qBAAA,CAAiC,aAAa,CAAC,EAAE;IACnD,IAAI,IAAAI,4BAAc,EAACN,QAAQ,CAAC,EAAE;MAC5B,OAAO,IAAAO,0BAAY,EAACT,MAAM,EAAEC,WAAW,EAAEC,QAAQ,EAAEnC,IAAI,EAAE;QACvD,GAAGoC,OAAO;QACV;QACAO,IAAI,EAAE;MACR,CAAC,CAAC;IACJ;EACF;EAEA,IAAIP,OAAO,CAACO,IAAI,KAAK,OAAO,EAAE;IAC5B,OAAOC,+BAAM,CAACZ,SAAS,CAACC,MAAM,EAAEC,WAAW,EAAEC,QAAQ,EAAEnC,IAAI,EAAEoC,OAAO,CAAC;EACvE;EAEA,KAAAE,sBAAA,GAAIF,OAAO,CAACI,sBAAsB,cAAAF,sBAAA,eAA9BA,sBAAA,CAAiC,aAAa,CAAC,EAAE;IACnD,IAAI,iBAAiB,CAACO,IAAI,CAACV,QAAQ,CAAC,EAAE;MACpC,OAAOW,YAAY,CAACb,MAAM,EAAEC,WAAW,EAAEC,QAAQ,EAAEnC,IAAI,EAAEoC,OAAO,CAAC;IACnE;EACF;EAEA,MAAMW,WAAW,IAAAR,sBAAA,GAAGH,OAAO,CAACI,sBAAsB,cAAAD,sBAAA,uBAA9BA,sBAAA,CAAgCQ,WAAW;EAE/D,IACEA,WAAW,KAAK,QAAQ;EACxB;EACA;EACAZ,QAAQ,CAACa,KAAK,CAAC,IAAIC,MAAM,CAAE,mBAAkBb,OAAO,CAACc,QAAS,yBAAwB,CAAC,CAAC,EACxF;IACA;IACA,OAAON,+BAAM,CAACZ,SAAS,CACrBC,MAAM,EACNC,WAAW,EACXC,QAAQ,EACR,CAACC,OAAO,CAACe,MAAM,GACXC,MAAM,CAACC,IAAI;IACT;IACA;IACA,mFAAmF,CACpF,GACDD,MAAM,CAACC,IAAI,CAAC,EAAE,CAAC,EACnBjB,OAAO,CACR;EACH;EAEA,OAAOQ,+BAAM,CAACZ,SAAS,CAACC,MAAM,EAAEC,WAAW,EAAEC,QAAQ,EAAEnC,IAAI,EAAEoC,OAAO,CAAC;AACvE;AAEO,eAAeU,YAAYA,CAChCb,MAA2B,EAC3BC,WAAmB,EACnBC,QAAgB,EAChBnC,IAAY,EACZoC,OAA2B,EACC;EAAA,IAAAkB,sBAAA;EAC5B;EACA,IAAIlB,OAAO,CAACc,QAAQ,KAAK,KAAK,EAAE;IAC9B,MAAMK,IAAI,GAAG,IAAAC,4BAAc,EAACrB,QAAQ,CAAC,GAAG,yCAAyC,GAAG,EAAE;IACtF,OAAOS,+BAAM,CAACZ,SAAS,CACrBC,MAAM,EACNC,WAAW,EACXC,QAAQ;IACR;IACAiB,MAAM,CAACC,IAAI,CAACE,IAAI,CAAC,EACjBnB,OAAO,CACR;EACH;EAEA,IAAImB,IAAI,GAAGvD,IAAI,CAACyD,QAAQ,CAAC,MAAM,CAAC;;EAEhC;EACAF,IAAI,GAAG,MAAM,IAAAG,iCAAsB,EAACxB,WAAW,EAAE;IAC/CyB,GAAG,EAAEJ,IAAI;IACTpB;EACF,CAAC,CAAC;;EAEF;EACA,MAAMyB,MAAM,GAAG,IAAAC,iBAAS,EAAC1B,QAAQ,CAAC;EAClC,IAAIyB,MAAM,EAAE;IACVL,IAAI,GAAG,IAAAO,mBAAW,EAAC5B,WAAW,EAAE;MAAEC,QAAQ;MAAEwB,GAAG,EAAEJ;IAAK,CAAC,EAAE;MAAEK;IAAO,CAAC,CAAC,CAACD,GAAG;EAC1E;;EAEA;EACA;EACA,IAAI,IAAAH,4BAAc,EAACrB,QAAQ,CAAC,EAAE;IAAA,IAAA4B,qBAAA;IAC5B,MAAMC,OAAO,GAAG,MAAM,IAAAC,mCAAqB,EAAC;MAC1C9B,QAAQ;MACRwB,GAAG,EAAEJ,IAAI;MACTnB,OAAO,EAAE;QACPF,WAAW;QACXgC,GAAG,EAAE9B,OAAO,CAAC8B,GAAG;QAChBf,MAAM,EAAEf,OAAO,CAACe,MAAM;QACtBgB,SAAS,EAAE;MACb;IACF,CAAC,CAAC;IAEF,MAAMC,eAAe,GAAG,MAAMxB,+BAAM,CAACZ,SAAS,CAC5CC,MAAM,EACNC,WAAW,EACXC,QAAQ,EACRiB,MAAM,CAACC,IAAI,CAACW,OAAO,CAACK,MAAM,CAAC,EAC3BjC,OAAO,CACR;IAED,MAAMkC,OAAO,GAAGN,OAAO,CAACO,GAAG,CAACd,QAAQ,EAAE;IACtC,MAAMY,MAAkB,GAAG,CACzB;MACE1B,IAAI,EAAE,WAAW;MACjB3C,IAAI,EAAE;QACJ;QACA,KAAA+D,qBAAA,GAAGK,eAAe,CAACC,MAAM,CAAC,CAAC,CAAC,cAAAN,qBAAA,uBAAzBA,qBAAA,CAA2B/D,IAAI;QAElC;QACAuE,GAAG,EAAE;UACHhB,IAAI,EAAEe,OAAO;UACbE,SAAS,EAAEzC,UAAU,CAACuC,OAAO,CAAC;UAC9BG,GAAG,EAAE,EAAE;UACPC,WAAW,EAAE;QACf;MACF;IACF,CAAC,CACF;IAED,OAAO;MACLC,YAAY,EAAEP,eAAe,CAACO,YAAY;MAC1CN;IACF,CAAC;EACH;;EAEA;;EAEA,MAAM;IAAErC;EAAU,CAAC,GAAG,MAAA4C,OAAA,CAAAC,OAAA,GAAAC,IAAA,OAAA9D,uBAAA,CAAAd,OAAA,CAAa,cAAc,GAAC;;EAElD;EACA;;EAEA,MAAM6E,UAAU,GAAG/C,SAAS,CAAC;IAC3BG,QAAQ;IACRoB,IAAI,EAAEH,MAAM,CAACC,IAAI,CAACE,IAAI,CAAC;IACvBY,SAAS,EAAE,KAAK;IAChBa,UAAU,EAAE,KAAK;IACjB9C,WAAW;IACXiB,MAAM,EAAEf,OAAO,CAACe;EAClB,CAAC,CAAC;;EAEF;EACA;EACA;;EAEA;EACA;EACA,MAAMiB,eAAe,GAAG,MAAMxB,+BAAM,CAACZ,SAAS,CAC5CC,MAAM,EACNC,WAAW,EACXC,QAAQ,EACRC,OAAO,CAAC8B,GAAG,GAAGd,MAAM,CAACC,IAAI,CAAC,IAAA4B,yBAAkB,EAAC;IAAEtB,GAAG,EAAEJ,IAAI;IAAEpB;EAAS,CAAC,CAAC,CAAC,GAAGiB,MAAM,CAACC,IAAI,CAAC,EAAE,CAAC,EACxFjB,OAAO,CACR;EAED,MAAMkC,OAAO,GAAGS,UAAU,CAACxB,IAAI,CAACE,QAAQ,EAAE;;EAE1C;EACA;EACA;EACA,MAAMY,MAAkB,GAAG,CACzB;IACE1B,IAAI,EAAE,WAAW;IACjB3C,IAAI,EAAE;MACJ;MACA,KAAAsD,sBAAA,GAAGc,eAAe,CAACC,MAAM,CAAC,CAAC,CAAC,cAAAf,sBAAA,uBAAzBA,sBAAA,CAA2BtD,IAAI;MAElC;MACAuE,GAAG,EAAE;QACHhB,IAAI,EAAEe,OAAO;QACbE,SAAS,EAAEzC,UAAU,CAACuC,OAAO,CAAC;QAC9BG,GAAG,EAAE,EAAE;QACPC,WAAW,EAAE;MACf;IACF;EACF,CAAC,CACF;EAED,OAAO;IACLC,YAAY,EAAEP,eAAe,CAACO,YAAY;IAC1CN;EACF,CAAC;AACH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACAa,MAAM,CAACC,OAAO,GAAG;EACf;EACA,GAAGvC,+BAAM;EACTZ;AACF,CAAC"}