{"version":3,"file":"transform-worker.js","names":["_metroTransformWorker","data","_interopRequireDefault","require","_css","_cssModules","_postcss","_sass","obj","__esModule","default","countLines","transform","config","projectRoot","filename","options","startTime","Date","now","result","transformInner","endTime","duration","output","profiling","start","end","isCss","type","test","_options$customTransf","environment","customTransformOptions","match","RegExp","platform","worker","minify","Buffer","from","code","matchCssModule","toString","postcssResults","transformPostCssModule","src","hasPostcss","syntax","matchSass","compileSass","_jsModuleResults$outp","results","transformCssModuleWeb","dev","sourceMap","jsModuleResults","cssCode","css","lineCount","map","functionMap","dependencies","cssResults","cssModules","wrapDevelopmentCSS","skipCache","module","exports"],"sources":["../../src/transform-worker/transform-worker.ts"],"sourcesContent":["/**\n * Copyright 2023-present 650 Industries (Expo). All rights reserved.\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport worker, {\n  JsTransformerConfig,\n  JsTransformOptions,\n  TransformResponse,\n} from 'metro-transform-worker';\n\nimport { wrapDevelopmentCSS } from './css';\nimport { matchCssModule, transformCssModuleWeb } from './css-modules';\nimport { transformPostCssModule } from './postcss';\nimport { compileSass, matchSass } from './sass';\nimport { ExpoJsOutput, JsOutput } from '../serializer/jsOutput';\n\nconst countLines = require('metro/src/lib/countLines') as (string: string) => number;\n\nexport async function transform(\n  config: JsTransformerConfig,\n  projectRoot: string,\n  filename: string,\n  data: Buffer,\n  options: JsTransformOptions\n): Promise<TransformResponse> {\n  const startTime = Date.now();\n  const result = await transformInner(config, projectRoot, filename, data, options);\n  const endTime = Date.now();\n  const duration = endTime - startTime;\n\n  // @ts-expect-error\n  result.output[0].data.profiling = {\n    start: startTime,\n    end: endTime,\n    duration,\n  };\n  return result;\n}\n\nasync function transformInner(\n  config: JsTransformerConfig,\n  projectRoot: string,\n  filename: string,\n  data: Buffer,\n  options: JsTransformOptions\n): Promise<TransformResponse> {\n  const isCss = options.type !== 'asset' && /\\.(s?css|sass)$/.test(filename);\n  // If the file is not CSS, then use the default behavior.\n  if (!isCss) {\n    const environment = options.customTransformOptions?.environment;\n\n    if (\n      environment !== 'node' &&\n      // TODO: Ensure this works with windows.\n      (filename.match(new RegExp(`^app/\\\\+html(\\\\.${options.platform})?\\\\.([tj]sx?|[cm]js)?$`)) ||\n        // Strip +api files.\n        filename.match(/\\+api(\\.(native|ios|android|web))?\\.[tj]sx?$/))\n    ) {\n      // Remove the server-only +html file and API Routes from the bundle when bundling for a client environment.\n      return worker.transform(\n        config,\n        projectRoot,\n        filename,\n        !options.minify\n          ? Buffer.from(\n              // Use a string so this notice is visible in the bundle if the user is\n              // looking for it.\n              '\"> The server-only file was removed from the client JS bundle by Expo CLI.\"'\n            )\n          : Buffer.from(''),\n        options\n      );\n    }\n\n    if (\n      environment !== 'node' &&\n      !filename.match(/\\/node_modules\\//) &&\n      filename.match(/\\+api(\\.(native|ios|android|web))?\\.[tj]sx?$/)\n    ) {\n      // Clear the contents of +api files when bundling for the client.\n      // This ensures that the client doesn't accidentally use the server-only +api files.\n      return worker.transform(config, projectRoot, filename, Buffer.from(''), options);\n    }\n\n    return worker.transform(config, projectRoot, filename, data, options);\n  }\n\n  // If the platform is not web, then return an empty module.\n  if (options.platform !== 'web') {\n    const code = matchCssModule(filename) ? 'module.exports={ unstable_styles: {} };' : '';\n    return worker.transform(\n      config,\n      projectRoot,\n      filename,\n      // TODO: Native CSS Modules\n      Buffer.from(code),\n      options\n    );\n  }\n\n  let code = data.toString('utf8');\n\n  // Apply postcss transforms\n  const postcssResults = await transformPostCssModule(projectRoot, {\n    src: code,\n    filename,\n  });\n\n  if (postcssResults.hasPostcss) {\n    code = postcssResults.src;\n  }\n\n  // TODO: When native has CSS support, this will need to move higher up.\n  const syntax = matchSass(filename);\n  if (syntax) {\n    code = compileSass(projectRoot, { filename, src: code }, { syntax }).src;\n  }\n\n  // If the file is a CSS Module, then transform it to a JS module\n  // in development and a static CSS file in production.\n  if (matchCssModule(filename)) {\n    const results = await transformCssModuleWeb({\n      filename,\n      src: code,\n      options: {\n        projectRoot,\n        dev: options.dev,\n        minify: options.minify,\n        sourceMap: false,\n      },\n    });\n\n    const jsModuleResults = await worker.transform(\n      config,\n      projectRoot,\n      filename,\n      Buffer.from(results.output),\n      options\n    );\n\n    const cssCode = results.css.toString();\n    const output: JsOutput[] = [\n      {\n        type: 'js/module',\n        data: {\n          // @ts-expect-error\n          ...jsModuleResults.output[0]?.data,\n\n          // Append additional css metadata for static extraction.\n          css: {\n            code: cssCode,\n            lineCount: countLines(cssCode),\n            map: [],\n            functionMap: null,\n          },\n        },\n      },\n    ];\n\n    return {\n      dependencies: jsModuleResults.dependencies,\n      output,\n    };\n  }\n\n  // Global CSS:\n\n  const { transform } = require('lightningcss') as typeof import('lightningcss');\n\n  // TODO: Add bundling to resolve imports\n  // https://lightningcss.dev/bundling.html#bundling-order\n\n  const cssResults = transform({\n    filename,\n    code: Buffer.from(code),\n    sourceMap: false,\n    cssModules: false,\n    projectRoot,\n    minify: options.minify,\n  });\n\n  // TODO: Warnings:\n  // cssResults.warnings.forEach((warning) => {\n  // });\n\n  // Create a mock JS module that exports an empty object,\n  // this ensures Metro dependency graph is correct.\n  const jsModuleResults = await worker.transform(\n    config,\n    projectRoot,\n    filename,\n    options.dev ? Buffer.from(wrapDevelopmentCSS({ src: code, filename })) : Buffer.from(''),\n    options\n  );\n\n  const cssCode = cssResults.code.toString();\n\n  // In production, we export the CSS as a string and use a special type to prevent\n  // it from being included in the JS bundle. We'll extract the CSS like an asset later\n  // and append it to the HTML bundle.\n  const output: ExpoJsOutput[] = [\n    {\n      type: 'js/module',\n      data: {\n        ...(jsModuleResults.output[0] as ExpoJsOutput).data,\n\n        // Append additional css metadata for static extraction.\n        css: {\n          code: cssCode,\n          lineCount: countLines(cssCode),\n          map: [],\n          functionMap: null,\n          // Disable caching for CSS files when postcss is enabled and has been run on the file.\n          // This ensures that things like tailwind can update on every change.\n          skipCache: postcssResults.hasPostcss,\n        },\n      },\n    },\n  ];\n\n  return {\n    dependencies: jsModuleResults.dependencies,\n    output,\n  };\n}\n\n/**\n * A custom Metro transformer that adds support for processing Expo-specific bundler features.\n * - Global CSS files on web.\n * - CSS Modules on web.\n * - TODO: Tailwind CSS on web.\n */\nmodule.exports = {\n  // Use defaults for everything that's not custom.\n  ...worker,\n  transform,\n};\n"],"mappings":"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"}